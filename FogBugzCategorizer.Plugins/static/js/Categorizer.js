// Generated by CoffeeScript 1.3.3
var addSelectedTask, createProjectItem, createProjects, createSelectedProjectTask, createTaskItem, createTasks, getProjectTaskText, getSelectedCategories;

ï»¿$(function() {
  $.ajaxSetup({
    cache: false
  });
  console.log("jQuery version: " + ($().jquery));
  $('#CategorizerDiv').hide();
  $('#Categorizer').click(function(e) {
    e.preventDefault();
    $('#CategorizerDiv').toggle();
    if ($('#CategorizerDiv').is(':visible')) {
      return createProjects();
    }
  });
  return $('#CategorizerSave').click(function(e) {
    e.preventDefault();
    return $.ajax({
      type: 'POST',
      url: settings.url,
      data: JSON.stringify({
        Command: 'SaveCategories',
        Categories: getSelectedCategories()
      }),
      contentType: "application/json; charset=utf-8",
      dataType: 'json',
      success: function(result) {
        return console.log("finished saving categories, got result: " + result);
      }
    });
  });
});

createProjects = function() {
  var data;
  data = $('#CategorizerDiv').data('projects');
  if (data) {
    return;
  }
  $('#CategorizerProjects').empty();
  return $.getJSON(settings.url, {
    Command: 'GetProjects'
  }, function(json) {
    $.each(json, function(key, val) {
      return createProjectItem(val).appendTo('#CategorizerProjects');
    });
    return $('#CategorizerDiv').data('projects', json);
  });
};

createProjectItem = function(project) {
  var div;
  div = $('<div />');
  div.html(project.Name).click(function(e) {
    var data, projectObj;
    e.preventDefault();
    $('#CategorizerTasks').empty();
    data = $(this).data('tasks');
    if (data) {
      return createTasks(data);
    } else {
      projectObj = $(this);
      return $.getJSON(settings.url, {
        Command: 'GetTasks',
        Project: projectObj.html()
      }, function(json) {
        return createTasks(json, function() {
          return projectObj.data('tasks', json);
        });
      });
    }
  });
  return div;
};

createTasks = function(data, func) {
  $.each(data, function(key, val) {
    return createTaskItem(val).appendTo('#CategorizerTasks');
  });
  if (func) {
    return func();
  }
};

createTaskItem = function(task) {
  var div;
  div = $('<div />');
  div.html(task.Name).click(function(e) {
    e.preventDefault();
    if ($('#SelectedCategories div').filter(function() {
      return $(this).text() === getProjectTaskText(task) && $(this).is(':visible');
    }).length < 1) {
      return addSelectedTask($(this), task);
    }
  });
  return div;
};

addSelectedTask = function(taskObj, task) {
  createSelectedProjectTask(taskObj, task);
  return taskObj.hide();
};

createSelectedProjectTask = function(taskObj, task) {
  var div;
  div = $('<div />');
  div.data('task', task);
  div.html(getProjectTaskText(task)).click(function(e) {
    e.preventDefault();
    $(this).hide();
    return taskObj.show();
  });
  return div.appendTo('#SelectedCategories');
};

getProjectTaskText = function(task) {
  return "" + task.Project.Name + ": " + task.Name;
};

getSelectedCategories = function() {
  var categories;
  categories = [];
  $('#SelectedCategories div').each(function() {
    return categories.push($(this).data('task'));
  });
  return categories;
};
